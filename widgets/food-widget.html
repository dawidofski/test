<style>
    /* --- Layout --- */
    .nw-widget {
        width: 100%;
        height: 100%;
        padding: 15px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
    }

    .widget-swipe-area { touch-action: pan-y; }

    /* --- Header --- */
    .nw-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        min-height: 30px;
    }

    .nw-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-color);
        cursor: pointer;
    }

    .nw-dots { display: flex; gap: 5px; }
    .nw-dot {
        width: 6px; height: 6px; border-radius: 50%; background: #ccc;
        transition: background 0.3s;
    }
    .nw-dot.active { background: var(--accent-color); }

    /* --- Carousel --- */
    .nw-views-wrapper {
        flex-grow: 1;
        position: relative;
        width: 100%;
        min-height: 240px;
    }

    .nw-view {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease, transform 0.3s ease;
        transform: translateX(20px);
        display: flex;
        flex-direction: column;
        background: var(--card-bg);
        z-index: 0;
    }
    
    @media (prefers-color-scheme: dark) {
        .nw-view { background: #1e1e1e; }
    }

    .nw-view.active {
        opacity: 1; pointer-events: all;
        transform: translateX(0); z-index: 10;
    }

    /* --- View 1: Daily Progress --- */
    .nw-chart-container {
        flex-grow: 1;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        max-height: 180px;
    }
    
    /* Center text inside donut chart */
    .nw-chart-center {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        pointer-events: none;
    }
    .nw-cal-big { font-size: 20px; font-weight: bold; color: var(--text-color); }
    .nw-cal-sub { font-size: 11px; color: #888; }

    .nw-macros {
        display: flex;
        justify-content: space-around;
        margin-top: 10px;
        font-size: 12px;
        font-weight: 600;
    }
    .nw-macro-item { text-align: center; }
    .nw-pro { color: #3b82f6; }
    .nw-fat { color: #eab308; }
    .nw-carb { color: #ef4444; }

    .nw-add-btn {
        width: 100%; padding: 10px; margin-top: auto;
        background: rgba(0,0,0,0.05); border: none; border-radius: 8px;
        color: var(--text-color); font-weight: 600; cursor: pointer;
    }

    /* --- View 2: History --- */
    .nw-controls { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .nw-select {
        padding: 5px; font-size: 12px; border-radius: 6px;
        border: 1px solid #ccc; background: rgba(0,0,0,0.05);
        color: var(--text-color);
    }
    .nw-history-wrapper { flex-grow: 1; position: relative; width: 100%; min-height: 150px; }

    /* --- Overlays --- */
    .nw-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.6); z-index: 2000; 
        display: none; justify-content: center; align-items: center; 
    }
    .nw-overlay-content { 
        background: var(--card-bg); padding: 20px; border-radius: 12px; 
        max-width: 400px; width: 90%; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        color: var(--text-color); max-height: 90vh; overflow-y: auto;
    }
    .nw-form-group { margin-bottom: 12px; }
    .nw-form-group label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 13px; }
    .nw-input { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    
    .nw-row { display: flex; gap: 10px; }
    .nw-btn-row { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
    .nw-btn-save { background: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .nw-btn-cancel { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
    
    /* API Search Results */
    .nw-api-results {
        max-height: 150px; overflow-y: auto; margin-top: 5px;
        border: 1px solid #eee; border-radius: 6px; display: none;
    }
    .nw-api-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; }
    .nw-api-item:hover { background: rgba(0,0,0,0.05); }

    .nw-tab-bar { display: flex; border-bottom: 1px solid #eee; margin-bottom: 15px; }
    .nw-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #888; font-weight: 600; }
    .nw-tab.active { color: var(--accent-color); border-bottom: 2px solid var(--accent-color); }

</style>

<div class="nw-widget widget-swipe-area" id="nw-widget-root">
    
    <div class="nw-header-row">
        <div class="nw-title" id="nw-view-title">Nutrition Today</div>
        <div class="nw-dots">
            <div class="nw-dot active" data-idx="0"></div>
            <div class="nw-dot" data-idx="1"></div>
        </div>
    </div>

    <div class="nw-views-wrapper">
        
        <div class="nw-view active" id="nw-view-0">
            <div class="nw-chart-container">
                <canvas id="nw-chart-daily"></canvas>
                <div class="nw-chart-center">
                    <div class="nw-cal-big" id="nw-val-cal">0</div>
                    <div class="nw-cal-sub">KCAL LEFT</div>
                </div>
            </div>
            
            <div class="nw-macros">
                <div class="nw-macro-item nw-pro">PRO<br><span id="nw-val-pro">0g</span></div>
                <div class="nw-macro-item nw-fat">FAT<br><span id="nw-val-fat">0g</span></div>
                <div class="nw-macro-item nw-carb">CARB<br><span id="nw-val-carb">0g</span></div>
            </div>

            <button class="nw-add-btn" id="nw-open-log-btn">+ Log Food</button>
        </div>

        <div class="nw-view" id="nw-view-1">
            <div class="nw-controls">
                <select id="nw-hist-range" class="nw-select">
                    <option value="week">This Week</option>
                    <option value="month" selected>This Month</option>
                </select>
            </div>
            <div class="nw-history-wrapper">
                <canvas id="nw-chart-history"></canvas>
            </div>
        </div>

    </div>
</div>

<div id="nw-log-overlay" class="nw-overlay">
    <div class="nw-overlay-content">
        <div class="nw-header-row">
            <h3 style="margin:0">Log Food</h3>
            <button class="nw-btn-cancel" style="padding:5px 10px;" id="nw-log-close">‚úï</button>
        </div>

        <div class="nw-tab-bar">
            <div class="nw-tab active" id="nw-tab-search">Search</div>
            <div class="nw-tab" id="nw-tab-manual">Manual</div>
        </div>

        <div id="nw-view-search">
            <div class="nw-row">
                <input type="text" id="nw-api-input" class="nw-input" placeholder="Search food (e.g. Apple)">
                <button id="nw-api-btn" class="nw-btn-save" style="flex-shrink:0">üîç</button>
            </div>
            <div id="nw-api-results" class="nw-api-results"></div>
        </div>

        <form id="nw-log-form" style="margin-top:15px;">
            <div class="nw-form-group">
                <label>Name</label>
                <input type="text" id="nw-log-name" class="nw-input" required>
            </div>
            <div class="nw-row">
                <div class="nw-form-group" style="flex:1">
                    <label>Grams</label>
                    <input type="number" id="nw-log-g" class="nw-input" value="100">
                </div>
                <div class="nw-form-group" style="flex:1">
                    <label>Calories</label>
                    <input type="number" id="nw-log-cal" class="nw-input" required>
                </div>
            </div>
            <div class="nw-row">
                <div class="nw-form-group" style="flex:1"><label>Pro</label><input type="number" id="nw-log-p" class="nw-input" step="0.1"></div>
                <div class="nw-form-group" style="flex:1"><label>Fat</label><input type="number" id="nw-log-f" class="nw-input" step="0.1"></div>
                <div class="nw-form-group" style="flex:1"><label>Carb</label><input type="number" id="nw-log-c" class="nw-input" step="0.1"></div>
            </div>
            <div class="nw-form-group">
                <label>Meal</label>
                <select id="nw-log-meal" class="nw-input">
                    <option>Breakfast</option><option>Lunch</option><option>Dinner</option><option>Snack</option>
                </select>
            </div>
            <button type="submit" class="nw-btn-save" style="width:100%">Add Log</button>
        </form>
    </div>
</div>

<div id="nw-goal-overlay" class="nw-overlay">
    <div class="nw-overlay-content">
        <h3>Set Daily Goals</h3>
        <form id="nw-goal-form">
            <div class="nw-form-group"><label>Calories Goal</label><input type="number" id="nw-goal-cal" class="nw-input"></div>
            <div class="nw-row">
                <div class="nw-form-group"><label>Protein</label><input type="number" id="nw-goal-p" class="nw-input"></div>
                <div class="nw-form-group"><label>Fat</label><input type="number" id="nw-goal-f" class="nw-input"></div>
                <div class="nw-form-group"><label>Carbs</label><input type="number" id="nw-goal-c" class="nw-input"></div>
            </div>
            <div class="nw-btn-row">
                <button type="button" id="nw-goal-cancel" class="nw-btn-cancel">Cancel</button>
                <button type="submit" class="nw-btn-save">Save Goals</button>
            </div>
        </form>
    </div>
</div>

<script>
(() => {
    // === DOM & STATE ===
    const root = document.getElementById('nw-widget-root');
    const titleEl = document.getElementById('nw-view-title');
    const dots = root.querySelectorAll('.nw-dot');
    const views = [document.getElementById('nw-view-0'), document.getElementById('nw-view-1')];
    const titles = ["Nutrition Today", "Calorie History"];
    
    let currentView = 0;
    let dailyChart = null;
    let histChart = null;
    
    // Helper date
    const getTodayStr = () => {
        const d = new Date();
        return new Date(d.getTime() - (d.getTimezoneOffset()*60000)).toISOString().split("T")[0];
    };
    const todayStr = getTodayStr();

    const isAlive = () => root && root.isConnected;

    // --- Swipe Logic ---
    let touchStartX = 0, touchStartY = 0;
    root.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: true});
    root.addEventListener('touchend', e => {
        if (!isAlive()) return;
        const diffX = touchStartX - e.changedTouches[0].screenX;
        const diffY = touchStartY - e.changedTouches[0].screenY;
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 40) switchView(diffX > 0 ? 1 : -1);
    }, {passive: true});

    function switchView(dir) {
        if (!isAlive()) return;
        views[currentView].classList.remove('active');
        dots[currentView].classList.remove('active');
        currentView += dir;
        if (currentView >= views.length) currentView = 0;
        if (currentView < 0) currentView = views.length - 1;
        views[currentView].classList.add('active');
        dots[currentView].classList.add('active');
        titleEl.textContent = titles[currentView];
        refreshAll();
    }

    // ==========================
    // VIEW 0: DAILY LOGIC
    // ==========================
    async function loadDaily() {
        if (!isAlive()) return;
        
        // Defaults
        const defaults = { calorieGoal: 2000, proteinGoal: 150, fatGoal: 70, carbGoal: 200 };
        const settings = await window.db.settings.toArray();
        settings.forEach(s => defaults[s.key] = parseInt(s.value));

        const logs = await window.db.nutritionLogs.where('date').equals(todayStr).toArray();
        const totals = logs.reduce((acc, l) => {
            acc.cal += l.calories; acc.pro += l.protein; acc.fat += l.fat; acc.carb += l.carbs;
            return acc;
        }, {cal:0, pro:0, fat:0, carb:0});

        // Update Text
        document.getElementById('nw-val-cal').textContent = Math.max(0, defaults.calorieGoal - totals.cal);
        document.getElementById('nw-val-pro').textContent = `${totals.pro.toFixed(0)}/${defaults.proteinGoal}g`;
        document.getElementById('nw-val-fat').textContent = `${totals.fat.toFixed(0)}/${defaults.fatGoal}g`;
        document.getElementById('nw-val-carb').textContent = `${totals.carb.toFixed(0)}/${defaults.carbGoal}g`;

        // Update Chart
        initDailyChart(totals.cal, defaults.calorieGoal);
    }

    function initDailyChart(current, goal) {
        const ctx = document.getElementById('nw-chart-daily');
        if (!ctx) return;
        if (Chart.getChart(ctx)) Chart.getChart(ctx).destroy();

        dailyChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Consumed', 'Left'],
                datasets: [{
                    data: [current, Math.max(0, goal - current)],
                    backgroundColor: ['#007bff', '#e0e0e0'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
        });
    }

    // ==========================
    // VIEW 1: HISTORY LOGIC
    // ==========================
    const histSelect = document.getElementById('nw-hist-range');
    histSelect.onchange = loadHistory;

    async function loadHistory() {
        if (!isAlive() || currentView !== 1) return;
        
        const range = histSelect.value;
        const end = new Date();
        const start = new Date();
        if (range === 'week') start.setDate(end.getDate() - 6);
        else start.setDate(end.getDate() - 29);

        // Format for DB query
        const startStr = new Date(start.getTime() - (start.getTimezoneOffset()*60000)).toISOString().split("T")[0];
        const endStr = new Date(end.getTime() - (end.getTimezoneOffset()*60000)).toISOString().split("T")[0];

        const logs = await window.db.nutritionLogs.where('date').between(startStr, endStr, true, true).toArray();
        
        // Aggregate
        const daily = {};
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dStr = new Date(d.getTime() - (d.getTimezoneOffset()*60000)).toISOString().split("T")[0];
            daily[dStr] = 0;
        }
        logs.forEach(l => { if (daily[l.date] !== undefined) daily[l.date] += l.calories; });

        initHistChart(Object.keys(daily), Object.values(daily));
    }

    function initHistChart(labels, data) {
        const ctx = document.getElementById('nw-chart-history');
        if (!ctx) return;
        if (Chart.getChart(ctx)) Chart.getChart(ctx).destroy();

        const niceLabels = labels.map(d => d.slice(5)); // MM-DD

        histChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: niceLabels,
                datasets: [{
                    label: 'Calories',
                    data: data,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // ==========================
    // ACTIONS: ADD & GOALS
    // ==========================
    
    // --- LOG OVERLAY ---
    const logOverlay = document.getElementById('nw-log-overlay');
    const logForm = document.getElementById('nw-log-form');
    const searchDiv = document.getElementById('nw-view-search');
    const searchRes = document.getElementById('nw-api-results');
    
    // Base API values for recalculation
    let baseNutrients = null;

    document.getElementById('nw-open-log-btn').onclick = () => {
        logForm.reset(); baseNutrients = null;
        searchDiv.style.display = 'block';
        searchRes.style.display = 'none';
        logOverlay.style.display = 'flex';
        switchTab('search');
    };
    document.getElementById('nw-log-close').onclick = () => logOverlay.style.display = 'none';

    // Tabs
    function switchTab(t) {
        document.querySelectorAll('.nw-tab').forEach(el => el.classList.remove('active'));
        document.getElementById('nw-tab-'+t).classList.add('active');
        if (t === 'search') {
            searchDiv.style.display = 'block';
            document.getElementById('nw-log-name').readOnly = true;
        } else {
            searchDiv.style.display = 'none';
            document.getElementById('nw-log-name').readOnly = false;
        }
    }
    document.getElementById('nw-tab-search').onclick = () => switchTab('search');
    document.getElementById('nw-tab-manual').onclick = () => switchTab('manual');

    // API Search
    document.getElementById('nw-api-btn').onclick = async () => {
        const q = document.getElementById('nw-api-input').value;
        if (!q) return;
        searchRes.style.display = 'block';
        searchRes.innerHTML = '<div style="padding:10px;">Searching...</div>';
        try {
            const res = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${q}&search_simple=1&action=process&json=1`);
            const data = await res.json();
            searchRes.innerHTML = '';
            if(data.products.length === 0) searchRes.innerHTML = '<div style="padding:10px;">No results.</div>';
            
            data.products.slice(0,10).forEach(p => {
                const item = document.createElement('div');
                item.className = 'nw-api-item';
                item.innerHTML = `<b>${p.product_name}</b> <span style="color:#888">${Math.round(p.nutriments['energy-kcal_100g']||0)} cal/100g</span>`;
                item.onclick = () => fillForm(p);
                searchRes.appendChild(item);
            });
        } catch(e) { searchRes.innerHTML = '<div style="padding:10px; color:red">Error</div>'; }
    };

    function fillForm(p) {
        baseNutrients = {
            cal: p.nutriments['energy-kcal_100g'] || 0,
            pro: p.nutriments.proteins_100g || 0,
            fat: p.nutriments.fat_100g || 0,
            carb: p.nutriments.carbohydrates_100g || 0
        };
        document.getElementById('nw-log-name').value = p.product_name;
        document.getElementById('nw-log-g').value = 100;
        recalc(100);
        searchRes.style.display = 'none';
    }

    function recalc(g) {
        if (!baseNutrients) return;
        const r = g / 100;
        document.getElementById('nw-log-cal').value = Math.round(baseNutrients.cal * r);
        document.getElementById('nw-log-p').value = (baseNutrients.pro * r).toFixed(1);
        document.getElementById('nw-log-f').value = (baseNutrients.fat * r).toFixed(1);
        document.getElementById('nw-log-c').value = (baseNutrients.carb * r).toFixed(1);
    }

    document.getElementById('nw-log-g').oninput = (e) => recalc(e.target.value);

    logForm.onsubmit = async (e) => {
        e.preventDefault();
        await window.db.nutritionLogs.add({
            date: todayStr,
            foodName: document.getElementById('nw-log-name').value,
            amountG: parseInt(document.getElementById('nw-log-g').value),
            calories: parseInt(document.getElementById('nw-log-cal').value),
            protein: parseFloat(document.getElementById('nw-log-p').value),
            fat: parseFloat(document.getElementById('nw-log-f').value),
            carbs: parseFloat(document.getElementById('nw-log-c').value),
            mealType: document.getElementById('nw-log-meal').value
        });
        logOverlay.style.display = 'none';
        refreshAll();
    };

    // --- GOALS OVERLAY ---
    const goalOverlay = document.getElementById('nw-goal-overlay');
    const goalForm = document.getElementById('nw-goal-form');

    titleEl.onclick = async () => {
        if (currentView !== 0) return;
        // Load current settings
        const def = { calorieGoal: 2000, proteinGoal: 150, fatGoal: 70, carbGoal: 200 };
        const s = await window.db.settings.toArray();
        s.forEach(x => def[x.key] = x.value);
        
        document.getElementById('nw-goal-cal').value = def.calorieGoal;
        document.getElementById('nw-goal-p').value = def.proteinGoal;
        document.getElementById('nw-goal-f').value = def.fatGoal;
        document.getElementById('nw-goal-c').value = def.carbGoal;
        
        goalOverlay.style.display = 'flex';
    };
    document.getElementById('nw-goal-cancel').onclick = () => goalOverlay.style.display = 'none';

    goalForm.onsubmit = async (e) => {
        e.preventDefault();
        await window.db.settings.bulkPut([
            { key: 'calorieGoal', value: parseInt(document.getElementById('nw-goal-cal').value) },
            { key: 'proteinGoal', value: parseInt(document.getElementById('nw-goal-p').value) },
            { key: 'fatGoal', value: parseInt(document.getElementById('nw-goal-f').value) },
            { key: 'carbGoal', value: parseInt(document.getElementById('nw-goal-c').value) }
        ]);
        goalOverlay.style.display = 'none';
        refreshAll();
    };

    function refreshAll() {
        loadDaily();
        if (currentView === 1) loadHistory();
    }

    // Init
    loadDaily();

})();
</script>