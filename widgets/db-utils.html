<div class="p-4">
    <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Settings & Backup</h2>

    <!-- Authentication Section -->
    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm mb-6">
        <h3 class="font-semibold mb-3 text-gray-700 dark:text-gray-300">GitHub Configuration</h3>
        
        <div class="space-y-3">
            <div>
                <label class="block text-sm text-gray-500">Personal Access Token (PAT)</label>
                <input type="password" id="gh-pat" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="ghp_...">
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm text-gray-500">Username/Owner</label>
                    <input type="text" id="gh-owner" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-500">Repo Name</label>
                    <input type="text" id="gh-repo" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="backup">
                </div>
            </div>
            <button id="btn-save-auth" class="w-full bg-blue-600 text-white py-2 rounded font-medium">Save Configuration</button>
        </div>
    </div>

    <!-- Actions -->
    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm">
        <h3 class="font-semibold mb-3 text-gray-700 dark:text-gray-300">Database Actions</h3>
        
        <div class="space-y-3">
            <button id="btn-backup-now" class="w-full bg-green-600 text-white py-2 rounded font-medium flex justify-center items-center gap-2">
                <span>☁️</span> Backup Now
            </button>
            
            <div id="backup-status" class="text-sm text-center text-gray-500 mt-2"></div>

            <hr class="border-gray-200 dark:border-gray-700 my-4">
            
            <button id="btn-export-json" class="w-full border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 py-2 rounded">
                Download JSON (Local)
            </button>
            
            <button id="btn-wipe" class="w-full border border-red-300 text-red-600 py-2 rounded mt-4">
                ⚠️ Wipe Database
            </button>
        </div>
    </div>
</div>

<script>
(function() {
    // --- Logic Scoped to Widget ---
    const statusEl = document.getElementById('backup-status');
    
    // 1. Load Settings
    const loadSettings = () => {
        document.getElementById('gh-pat').value = localStorage.getItem('gh_pat') || '';
        document.getElementById('gh-owner').value = localStorage.getItem('gh_owner') || '';
        document.getElementById('gh-repo').value = localStorage.getItem('gh_repo') || 'backup';
    };

    // 2. Save Settings
    document.getElementById('btn-save-auth').onclick = () => {
        localStorage.setItem('gh_pat', document.getElementById('gh-pat').value);
        localStorage.setItem('gh_owner', document.getElementById('gh-owner').value);
        localStorage.setItem('gh_repo', document.getElementById('gh-repo').value);
        statusEl.textContent = "✅ Settings Saved";
        setTimeout(() => statusEl.textContent = '', 2000);
    };

    // 3. Core Backup Logic
    const performBackup = async (silent = false) => {
        if(!silent) statusEl.textContent = "⏳ Preparing backup...";
        
        const pat = localStorage.getItem('gh_pat');
        const owner = localStorage.getItem('gh_owner');
        const repo = localStorage.getItem('gh_repo');

        if (!pat || !owner || !repo) {
            if(!silent) alert("Missing GitHub settings.");
            return;
        }

        try {
            // Export DB
            const data = {};
            await db.transaction('r', db.tables, async () => {
                for (const table of db.tables) {
                    if (table.name !== 'widgetCache') { // Skip cache
                        data[table.name] = await table.toArray();
                    }
                }
            });
            
            const jsonContent = JSON.stringify(data);
            const dateStr = new Date().toISOString().split('T')[0];
            const filename = `life_organizer_backup_${dateStr}.json`;
            const contentBase64 = btoa(unescape(encodeURIComponent(jsonContent)));

            // Check for existing file SHA to update (or create new)
            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${filename}`;
            let sha = null;
            
            try {
                const checkRes = await fetch(apiUrl, { 
                    headers: { 'Authorization': `token ${pat}` } 
                });
                if (checkRes.ok) {
                    const fileData = await checkRes.json();
                    sha = fileData.sha;
                }
            } catch (e) { /* File doesn't exist, proceed */ }

            // Upload
            const body = { message: `Daily Backup ${dateStr}`, content: contentBase64 };
            if (sha) body.sha = sha;

            const uploadRes = await fetch(apiUrl, {
                method: 'PUT',
                headers: { 
                    'Authorization': `token ${pat}`, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify(body)
            });

            if (!uploadRes.ok) throw new Error(`GitHub Error: ${uploadRes.status}`);

            // Success
            localStorage.setItem('last_backup_ts', Date.now());
            statusEl.textContent = `✅ Backup Success (${new Date().toLocaleTimeString()})`;
            statusEl.className = "text-sm text-center text-green-600 mt-2";

        } catch (e) {
            console.error(e);
            if(!silent) statusEl.textContent = `❌ Error: ${e.message}`;
        }
    };

    // 4. Auto Backup Check (Runs on widget load)
    const checkAutoBackup = () => {
        const lastBackup = parseInt(localStorage.getItem('last_backup_ts') || '0');
        const now = Date.now();
        const ONE_DAY = 24 * 60 * 60 * 1000;

        if (now - lastBackup > ONE_DAY) {
            console.log("Running auto-backup...");
            performBackup(true);
        } else {
            const date = new Date(lastBackup);
            statusEl.textContent = `Last backup: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        }
    };

    // 5. Other Buttons
    document.getElementById('btn-backup-now').onclick = () => performBackup(false);
    
    document.getElementById('btn-wipe').onclick = async () => {
        if(confirm("This will wipe ALL data. Are you sure?")) {
            await db.delete();
            location.reload();
        }
    };

    document.getElementById('btn-export-json').onclick = async () => {
        const data = {};
        await db.transaction('r', db.tables, async () => {
            for (const table of db.tables) {
                if(table.name !== 'widgetCache') data[table.name] = await table.toArray();
            }
        });
        const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_${new Date().toISOString()}.json`;
        a.click();
    };

    // Init
    loadSettings();
    checkAutoBackup();
})();
</script>