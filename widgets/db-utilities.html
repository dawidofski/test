<style>
    /* --- General & Mobile Layout --- */
    .util-container {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
        background: var(--card-bg);
        border-radius: 16px;
    }

    /* --- Tabs Navigation --- */
    .util-tabs {
        display: flex;
        overflow-x: auto;
        background: rgba(0, 0, 0, 0.03);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding: 10px 5px 0 5px;
        flex-shrink: 0;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }

    .util-tabs::-webkit-scrollbar {
        display: none;
    }

    .util-tab {
        padding: 10px 15px;
        margin: 0 5px;
        border-radius: 10px 10px 0 0;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        color: #666;
        white-space: nowrap;
        transition: all 0.2s;
        border-bottom: 3px solid transparent;
    }

    .util-tab.active {
        background: var(--card-bg);
        color: #3b82f6;
        border-bottom-color: #3b82f6;
    }

    /* --- Tab Content --- */
    .util-content-area {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        position: relative;
    }

    .util-tab-content {
        display: none;
        animation: fadeIn 0.3s;
    }

    .util-tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* --- Buttons --- */
    .util-btn {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border-radius: 12px;
        border: none;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.1s, opacity 0.2s;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .util-btn:active {
        transform: scale(0.98);
    }

    .util-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-backup {
        background-color: #24292e;
        color: white;
    }

    .btn-restore {
        background-color: #22c55e;
        color: white;
    }

    .btn-save {
        background-color: #3b82f6;
        color: white;
    }

    .btn-warn {
        background-color: #f59e0b;
        color: white;
    }

    .btn-danger {
        background-color: #ef4444;
        color: white;
    }

    .btn-info {
        background-color: #0ea5e9;
        color: white;
    }

    .btn-health {
        background-color: #8b5cf6;
        color: white;
    }

    /* --- Inputs --- */
    .input-field {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border-radius: 10px;
        border: 1px solid #ddd;
        box-sizing: border-box;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.5);
    }

    /* --- Logs --- */
    .status-log {
        background: #f8fafc;
        padding: 12px;
        border-radius: 10px;
        font-family: monospace;
        font-size: 11px;
        min-height: 80px;
        max-height: 200px;
        overflow-y: auto;
        margin-top: 15px;
        border: 1px solid #e2e8f0;
        color: #334155;
    }

    .log-entry {
        border-bottom: 1px solid #eee;
        padding: 4px 0;
    }

    .log-entry.error {
        color: #ef4444;
    }

    /* --- Notifications (Samsung Style) --- */
    .util-notify-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        width: 90%;
        max-width: 400px;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .util-toast {
        background: rgba(30, 41, 59, 0.95);
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        animation: slideDown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        pointer-events: auto;
    }

    .util-toast.success {
        background: rgba(34, 197, 94, 0.95);
    }

    .util-toast.error {
        background: rgba(239, 68, 68, 0.95);
    }

    .util-toast.warn {
        background: rgba(245, 158, 11, 0.95);
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeOut {
        to {
            opacity: 0;
            transform: translateY(-10px);
        }
    }

    h3 {
        margin-top: 0;
        font-size: 18px;
        margin-bottom: 5px;
    }

    p {
        margin-bottom: 15px;
        line-height: 1.4;
    }
</style>

<div class="util-container">
    <!-- Notifications -->
    <div class="util-notify-container" id="util-notify-area"></div>

    <!-- Tabs -->
    <div class="util-tabs">
        <div class="util-tab active" onclick="switchTab('config')">Config</div>
        <div class="util-tab" onclick="switchTab('health')">Health</div>
        <div class="util-tab" onclick="switchTab('import')">Import</div>
        <div class="util-tab" onclick="switchTab('backup')">Backup</div>
        <div class="util-tab" onclick="switchTab('manage')">Manage</div>
        <div class="util-tab" onclick="switchTab('diag')">Diag</div>
    </div>

    <!-- Content -->
    <div class="util-content-area">

        <!-- CONFIG -->
        <div id="tab-config" class="util-tab-content active">
            <h3>üîë Configuration</h3>
            <p style="font-size: 0.9em; color: #666;">Enter GitHub PAT for cloud backups.</p>
            <input type="password" id="gh-token-input" class="input-field" placeholder="github_pat_...">
            <button id="btn-save-token" class="util-btn btn-save">Save Token</button>
        </div>

        <!-- HEALTH -->
        <div id="tab-health" class="util-tab-content">
            <h3>‚ù§Ô∏è Health Data Import</h3>
            <p style="font-size: 0.9em; color: #666;">Sync data from Google Sheets.</p>
            <button id="btn-health-steps" class="util-btn btn-health">Import Steps</button>
            <button id="btn-health-hr" class="util-btn btn-health">Import Heart Rate</button>
            <button id="btn-health-sleep" class="util-btn btn-health">Import Sleep</button>
            <button id="btn-health-all" class="util-btn btn-save">Import All Health Data</button>
        </div>

        <!-- IMPORT -->
        <div id="tab-import" class="util-tab-content">
            <h3>üì• Data Import</h3>
            <p style="font-size: 0.9em; color: #666;">Upload JSON (words/sentences) or CSV (verbs).</p>
            <input type="file" id="import-file-input" class="input-field" accept=".json,.csv">
            <button id="btn-import-file" class="util-btn btn-save">Import Data</button>
        </div>

        <!-- BACKUP -->
        <div id="tab-backup" class="util-tab-content">
            <h3>‚òÅÔ∏è Unified Cloud Backup</h3>
            <p style="font-size: 0.9em; color: #666;">Backs up all Life Organizer and Spanish Data to GitHub.
            </p>
            <button id="btn-gh-backup" class="util-btn btn-backup">Backup Everything</button>
            <button id="btn-gh-restore" class="util-btn btn-restore">Restore Everything</button>
        </div>

        <!-- MANAGE -->
        <div id="tab-manage" class="util-tab-content">
            <h3>üßπ Data Management</h3>
            <p style="font-size: 0.9em; color: #666;">Reset specific parts of your database without losing others.</p>
            <button id="btn-wipe-spanish" class="util-btn btn-warn"><span>üá™üá∏</span> Wipe Spanish Data Only</button>
            <button id="btn-wipe-life" class="util-btn btn-warn"><span>üìÖ</span> Wipe Life Organizer Only</button>
            <button id="btn-wipe-all" class="util-btn btn-danger"><span>‚ö†Ô∏è</span> Factory Reset (Wipe All)</button>
        </div>

        <!-- DIAGNOSTICS -->
        <div id="tab-diag" class="util-tab-content">
            <h3>‚ö†Ô∏è Diagnostics & Logs</h3>
            <button id="btn-perf-check" class="util-btn btn-info">Run Performance Check</button>
            <button id="btn-update-widgets" class="util-btn btn-save">Check for Widget Updates</button>
            <button id="btn-test-error" class="util-btn btn-warn">Trigger Test Error</button>
            <button id="btn-view-logs" class="util-btn btn-info" style="background-color: #17a2b8; color:white;">View
                System Logs</button>
            <button id="btn-clear-logs" class="util-btn btn-danger">Clear Logs</button>

            <div id="backup-log" class="status-log">Ready...</div>
        </div>

    </div>
</div>

<script>
    (() => {
        // --- TAB LOGIC ---
        window.switchTab = (id) => {
            document.querySelectorAll('.util-tab').forEach(t => t.classList.remove('active'));
            const activeTab = Array.from(document.querySelectorAll('.util-tab')).find(t => t.getAttribute('onclick').includes(id));
            if (activeTab) activeTab.classList.add('active');

            document.querySelectorAll('.util-tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
        };

        // --- NOTIFICATION LOGIC ---
        function showNotify(msg, type = 'info') {
            const container = document.getElementById('util-notify-area');
            const toast = document.createElement('div');
            toast.className = `util-toast ${type}`;

            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'error') icon = '‚ùå';
            if (type === 'warn') icon = '‚ö†Ô∏è';

            toast.innerHTML = `<span>${icon}</span> ${msg}`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- DEFINITIONS ---
        const SPANISH_TABLES = ['words', 'sentences', 'myVocabulary', 'verbs', 'activityLog'];
        const LIFE_TABLES = [
            'habits', 'habitHistory', 'tasks', 'taskHistory', 'goals', 'mood',
            'sobrietyTrackers', 'sobrietyRelapses', 'sobrietyUrges',
            'financeTransactions', 'financeCategories', 'healthMetrics',
            'healthTimeSeries', 'sleepLogs', 'nutritionLogs', 'waterLogs', 'history'
        ];

        const logEl = document.getElementById('backup-log');

        // Config
        const REPO_OWNER = 'dawidofski';
        const REPO_NAME = 'backup';
        const FILE_PATH = 'life_organizer_full_backup.json';
        const API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;

        // Inputs
        const tokenInput = document.getElementById('gh-token-input');
        const fileInput = document.getElementById('import-file-input');

        function log(msg, type = 'info') {
            console.log(msg);
            const line = document.createElement('div');
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logEl.prepend(line);

            if (type !== 'silent') showNotify(msg, type);
        }

        // Load Token
        const savedToken = localStorage.getItem('gh_pat');
        if (savedToken) tokenInput.value = savedToken;

        document.getElementById('btn-save-token').onclick = () => {
            if (tokenInput.value.trim()) {
                localStorage.setItem('gh_pat', tokenInput.value.trim());
                log('Token saved successfully.', 'success');
            } else {
                showNotify('Please enter a token.', 'error');
            }
        };

        // --- HEALTH DATA HANDLERS ---
        const runHealthImport = async (fnName, label) => {
            if (typeof window[fnName] !== 'function') {
                log('Importer script not loaded.', 'error');
                return;
            }
            showNotify(`Importing ${label}...`, 'info');
            try {
                await window[fnName]();
                log(`${label} imported successfully.`, 'success');
            } catch (e) {
                log(e.message, 'error');
            }
        };

        document.getElementById('btn-health-steps').onclick = () => runHealthImport('importStepData', 'Steps');
        document.getElementById('btn-health-hr').onclick = () => runHealthImport('importHeartRateData', 'Heart Rate');
        document.getElementById('btn-health-sleep').onclick = () => runHealthImport('importSleepData', 'Sleep');

        document.getElementById('btn-health-all').onclick = async () => {
            if (typeof window.importStepData !== 'function') { log('Importer script not loaded.', 'error'); return; }
            showNotify('Importing All Health Data...', 'info');
            try {
                await window.importStepData();
                await window.importHeartRateData();
                await window.importSleepData();
                log('All Health Data imported successfully.', 'success');
            } catch (e) { log(e.message, 'error'); }
        };

        // --- IMPORT HANDLERS ---
        const importBtn = document.getElementById('btn-import-file');
        if (importBtn) {
            importBtn.onclick = () => {
                if (!fileInput || !fileInput.files.length) {
                    showNotify('Please select a file first.', 'warn');
                    return;
                }

                const file = fileInput.files[0];
                const fileExtension = file.name.split('.').pop().toLowerCase();
                showNotify(`Reading ${file.name}...`, 'info');

                if (fileExtension === 'json') {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            processJsonUpload(data);
                        } catch (error) {
                            log(`Error parsing JSON: ${error.message}`, 'error');
                        }
                    };
                    reader.readAsText(file);
                } else if (fileExtension === 'csv') {
                    if (typeof Papa === 'undefined') {
                        log("PapaParse library not loaded.", 'error');
                        return;
                    }
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        transformHeader: (h) => h.toLowerCase(),
                        complete: (results) => processCsvUpload(results.data),
                        error: (err) => log(`CSV Error: ${err.message}`, 'error')
                    });
                } else {
                    showNotify('Unsupported file type. Use .json or .csv', 'error');
                }
            };
        }

        async function processJsonUpload(data) {
            let wordsAdded = 0, sentencesAdded = 0;
            try {
                if (typeof data === 'object' && !Array.isArray(data) && (data.words || data.sentences)) {
                    if (data.words && Array.isArray(data.words)) {
                        const res = await importStandardWords(data.words);
                        wordsAdded = res.added;
                    }
                    if (data.sentences && Array.isArray(data.sentences)) {
                        const res = await importStandardSentences(data.sentences);
                        sentencesAdded = res.added;
                    }
                } else if (Array.isArray(data) && data.length > 0 && data[0].a && data[0]['un/una']) {
                    const res = await importNewWordFormat(data);
                    wordsAdded = res.added;
                } else if (Array.isArray(data) && data.length > 0 && data[0].topic) {
                    const res = await importNewSentenceFormat(data);
                    sentencesAdded = res.added;
                } else {
                    showNotify('Unknown JSON format.', 'error');
                    return;
                }

                log(`Import Done: +${wordsAdded} Words, +${sentencesAdded} Sentences.`, 'success');
            } catch (e) {
                log(`Import Failed: ${e.message}`, 'error');
            }
        }

        async function processCsvUpload(data) {
            if (!data || data.length === 0) { showNotify('Empty CSV.', 'error'); return; }

            if (data[0].infinitive !== undefined && data[0].form_1s !== undefined) {
                try {
                    showNotify('Processing Verbs...', 'info');
                    const res = await importVerbs(data);
                    log(`Verbs: +${res.added} added.`, 'success');
                } catch (e) {
                    log(`Verb Import Failed: ${e.message}`, 'error');
                }
            } else {
                showNotify('CSV missing "infinitive" or "form_1s" columns.', 'error');
            }
        }

        // --- IMPORT HELPERS ---
        async function importStandardWords(list) {
            if (!window.db.words) return { added: 0, skipped: 0 };
            const existing = new Set(await window.db.words.orderBy('spanish').keys());
            const toAdd = list.filter(w => w.spanish && !existing.has(w.spanish))
                .map(w => ({ spanish: w.spanish, english: w.english, learned: 0 }));
            if (toAdd.length) await window.db.words.bulkAdd(toAdd);
            return { added: toAdd.length, skipped: list.length - toAdd.length };
        }
        async function importStandardSentences(list) {
            if (!window.db.sentences) return { added: 0, skipped: 0 };
            const existing = new Set(await window.db.sentences.orderBy('spanish').keys());
            const toAdd = list.filter(s => s.spanish && !existing.has(s.spanish))
                .map(s => ({ spanish: s.spanish, english: s.english, learned: 0 }));
            if (toAdd.length) await window.db.sentences.bulkAdd(toAdd);
            return { added: toAdd.length, skipped: list.length - toAdd.length };
        }
        async function importNewWordFormat(list) {
            if (!window.db.words) return { added: 0, skipped: 0 };
            const existing = new Set(await window.db.words.orderBy('spanish').keys());
            const toAdd = [];
            for (const item of list) {
                const spa = item['un/una'];
                if (spa && !existing.has(spa)) {
                    toAdd.push({ spanish: spa, english: item.a, learned: 0 });
                    existing.add(spa);
                }
            }
            if (toAdd.length) await window.db.words.bulkAdd(toAdd);
            return { added: toAdd.length, skipped: list.length - toAdd.length };
        }
        async function importNewSentenceFormat(list) {
            if (!window.db.sentences) return { added: 0, skipped: 0 };
            const existing = new Set(await window.db.sentences.orderBy('spanish').keys());
            const toAdd = [];
            for (const item of list) {
                const spa = item.topic;
                if (spa && !existing.has(spa)) {
                    toAdd.push({ spanish: spa, english: "", learned: 0 });
                    existing.add(spa);
                }
            }
            if (toAdd.length) await window.db.sentences.bulkAdd(toAdd);
            return { added: toAdd.length, skipped: list.length - toAdd.length };
        }
        async function importVerbs(list) {
            if (!window.db.verbs) return { added: 0, skipped: 0 };
            const count = await window.db.verbs.count();
            if (count > 0 && !confirm(`Verbs table has ${count} entries. Add anyway?`)) {
                return { added: 0, skipped: list.length };
            }
            const toAdd = [];
            const mapping = { 'form_1s': '1s', 'form_2s': '2s', 'form_3s': '3s', 'form_1p': '1p', 'form_2p': '2p', 'form_3p': '3p' };
            for (const row of list) {
                for (const key in mapping) {
                    const person = mapping[key];
                    const form = row[key];
                    if (form && form.trim()) {
                        toAdd.push({
                            infinitive: row.infinitive, mood: row.mood, tense: row.tense,
                            person: person, form: form, learned: 0
                        });
                    }
                }
            }
            if (toAdd.length) await window.db.verbs.bulkAdd(toAdd);
            return { added: toAdd.length, skipped: 0 };
        }

        // --- ERROR & LOGGING HANDLERS ---
        document.getElementById('btn-test-error').onclick = () => {
            try {
                throw new Error("This is a manually triggered test error!");
            } catch (e) {
                window.ErrorHandler.logError('Manual Test', e);
                log("Error thrown and logged.", 'error');
            }
        };

        document.getElementById('btn-view-logs').onclick = async () => {
            logEl.innerHTML = "Loading logs...";
            try {
                if (!window.db.errorLogs) { logEl.innerHTML = "ErrorLogs table not found."; return; }
                const logs = await window.db.errorLogs.orderBy('timestamp').reverse().limit(20).toArray();
                if (logs.length === 0) { logEl.innerHTML = "No system logs found."; return; }
                logEl.innerHTML = logs.map(l => `
                    <div class="log-entry error">
                        <strong>${new Date(l.timestamp).toLocaleTimeString()}</strong><br>
                        ${l.message}
                    </div>
                `).join('');
            } catch (e) {
                logEl.innerText = "Failed to load logs: " + e.message;
            }
        };

        document.getElementById('btn-clear-logs').onclick = async () => {
            if (confirm("Delete all system logs?")) {
                if (window.db.errorLogs) await window.db.errorLogs.clear();
                log("Logs cleared.", 'success');
            }
        };

        // --- WIPE LOGIC ---
        async function wipeTables(tableNames, label) {
            if (!confirm(`Are you sure you want to wipe ALL ${label} data? This cannot be undone.`)) return;
            showNotify(`Wiping ${label} data...`, 'warn');
            try {
                await window.db.transaction('rw', tableNames, async () => {
                    for (const name of tableNames) {
                        if (window.db[name]) await window.db[name].clear();
                    }
                });
                log(`${label} data wiped successfully.`, 'success');
            } catch (e) {
                log(`Error wiping ${label}: ${e.message}`, 'error');
            }
        }

        document.getElementById('btn-wipe-spanish').onclick = () => wipeTables(SPANISH_TABLES, "Spanish Learning");
        document.getElementById('btn-wipe-life').onclick = () => wipeTables(LIFE_TABLES, "Life Organizer");

        document.getElementById('btn-wipe-all').onclick = async () => {
            if (!confirm("‚ö†Ô∏è FACTORY RESET: This will delete EVERYTHING. Are you sure?")) return;
            await window.db.delete();
            location.reload();
        };

        // --- PERFORMANCE CHECK ---
        document.getElementById('btn-perf-check').onclick = async () => {
            showNotify("Running diagnostics...", 'info');
            const start = performance.now();
            try {
                // Fix: bulkAdd returns the last key, not all keys.
                // We will clear the table first to ensure a clean state.
                await window.db.systemValidation.clear();

                await window.db.systemValidation.bulkAdd([
                    { test: 'perf', date: Date.now() },
                    { test: 'perf', date: Date.now() },
                    { test: 'perf', date: Date.now() }
                ]);

                // Fetch the actual records to get their IDs
                const records = await window.db.systemValidation.toArray();
                const ids = records.map(r => r.id);

                if (ids.length > 0) {
                    await window.db.systemValidation.bulkDelete(ids);
                }

                const end = performance.now();
                const duration = (end - start).toFixed(2);

                let totalRecords = 0;
                for (const table of window.db.tables) {
                    totalRecords += await table.count();
                }

                log(`Check Passed: ${duration}ms. Total Records: ${totalRecords}`, 'success');
            } catch (e) {
                log(`Diagnostics Failed: ${e.message}`, 'error');
            }
        };

        // --- BACKUP LOGIC (Unified) ---
        async function exportDB() {
            showNotify('Exporting all tables...', 'info');
            const data = {};
            await window.db.transaction('r', window.db.tables, async () => {
                for (const table of window.db.tables) {
                    if (table.name !== 'widgetCache') {
                        data[table.name] = await table.toArray();
                    }
                }
            });
            return JSON.stringify(data);
        }

        async function uploadToGitHub(content) {
            const token = localStorage.getItem('gh_pat');
            if (!token) throw new Error("No Token Saved");

            let sha = null;
            try {
                const res = await fetch(API_URL, {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (res.ok) {
                    const json = await res.json();
                    sha = json.sha;
                    log(`Found existing backup (SHA: ${sha.substring(0, 7)}...)`, 'silent');
                } else if (res.status === 404) {
                    log('No existing backup found, creating new file.', 'silent');
                }
            } catch (e) {
                log(`Warning checking file: ${e.message}`, 'silent');
            }

            const body = {
                message: `Unified Backup ${new Date().toISOString()}`,
                content: btoa(unescape(encodeURIComponent(content)))
            };

            // CRITICAL FIX: Only include 'sha' if we actually have one
            // Sending 'sha': null causes GitHub API 422 error
            if (sha) {
                body.sha = sha;
            }

            const res = await fetch(API_URL, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (!res.ok) {
                const errText = await res.text();
                throw new Error(`GitHub API ${res.status}: ${errText}`);
            }
        }

        document.getElementById('btn-gh-backup').onclick = async () => {
            const btn = document.getElementById('btn-gh-backup');
            btn.disabled = true;
            try {
                const json = await exportDB();
                await uploadToGitHub(json);
                log('Unified Backup Saved to GitHub!', 'success');
            } catch (e) {
                log('Backup Failed: ' + e.message, 'error');
            }
            btn.disabled = false;
        };

        document.getElementById('btn-gh-restore').onclick = async () => {
            if (!confirm("Overwrite local data with GitHub backup?")) return;
            const btn = document.getElementById('btn-gh-restore');
            btn.disabled = true;
            try {
                const token = localStorage.getItem('gh_pat');
                if (!token) throw new Error("No Token");

                const res = await fetch(API_URL, {
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3.raw' }
                });
                if (!res.ok) throw new Error('Download failed');

                const data = await res.json();
                showNotify('Importing...', 'info');

                await window.db.transaction('rw', window.db.tables, async () => {
                    for (const table of window.db.tables) {
                        if (table.name !== 'widgetCache') {
                            await table.clear();
                            if (data[table.name]) {
                                await table.bulkAdd(data[table.name]);
                            }
                        }
                    }
                });
                log('Restore Complete. Reloading...', 'success');
                setTimeout(() => location.reload(), 1500);
            } catch (e) {
                log('Restore Failed: ' + e.message, 'error');
            }
            btn.disabled = false;
        };

        document.getElementById('btn-update-widgets').onclick = async () => {
            if (window.loader) {
                showNotify('Checking for updates...', 'info');
                await window.loader.checkForUpdates(true);
            }
        };

    })();
</script>