<style>
    .util-container { font-family: -apple-system, sans-serif; color: var(--text-color); }
    .util-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    
    .util-btn {
        width: 100%;
        padding: 12px;
        margin: 5px 0;
        border-radius: 8px;
        border: none;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
    }
    .util-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-backup { background-color: #24292e; color: white; }
    .btn-restore { background-color: #28a745; color: white; }
    .btn-save { background-color: #007bff; color: white; }
    .btn-warn { background-color: #ffc107; color: #333; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-info { background-color: #17a2b8; color: white; }

    .input-field {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border-radius: 6px;
        border: 1px solid #ccc;
        box-sizing: border-box;
    }
    
    .status-log {
        background: rgba(0,0,0,0.05);
        padding: 10px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 12px;
        min-height: 60px;
        max-height: 150px;
        overflow-y: auto;
        margin-top: 10px;
    }
</style>

<div class="util-container">

    <div class="util-section">
        <h3>üîë Configuration</h3>
        <p style="font-size: 0.9em; color: #666;">Enter GitHub PAT for cloud backups.</p>
        <input type="password" id="gh-token-input" class="input-field" placeholder="github_pat_...">
        <button id="btn-save-token" class="util-btn btn-save">Save Token</button>
    </div>
    
    <div class="util-section">
        <h3>‚òÅÔ∏è Unified Cloud Backup</h3>
        <p style="font-size: 0.9em; color: #666;">Backs up <b>BOTH</b> Life Organizer and Spanish Data to GitHub.</p>
        <button id="btn-gh-backup" class="util-btn btn-backup">Backup Everything</button>
        <button id="btn-gh-restore" class="util-btn btn-restore">Restore Everything</button>
    </div>

    <div class="util-section">
        <h3>üßπ Data Management</h3>
        <p style="font-size: 0.9em; color: #666;">Reset specific parts of your database without losing others.</p>
        
        <button id="btn-wipe-spanish" class="util-btn btn-warn">
            <span>üá™üá∏</span> Wipe Spanish Data Only
        </button>
        <button id="btn-wipe-life" class="util-btn btn-warn">
            <span>üìÖ</span> Wipe Life Organizer Only
        </button>
        <button id="btn-wipe-all" class="util-btn btn-danger">
            <span>‚ö†Ô∏è</span> Factory Reset (Wipe All)
        </button>
    </div>

    <div class="util-section">
        <h3>‚ö° Diagnostics</h3>
        <button id="btn-perf-check" class="util-btn btn-info">Run Performance Check</button>
        <button id="btn-update-widgets" class="util-btn btn-save">Check for Widget Updates</button>
    </div>

    <div class="util-section">
        <h3>Log</h3>
        <div id="backup-log" class="status-log">Ready...</div>
    </div>

</div>

<script>
    (() => {
        // --- DEFINITIONS ---
        const SPANISH_TABLES = ['words', 'sentences', 'myVocabulary', 'verbs', 'activityLog'];
        const LIFE_TABLES = [
            'habits', 'habitHistory', 'tasks', 'taskHistory', 'goals', 'mood', 
            'sobrietyTrackers', 'sobrietyRelapses', 'sobrietyUrges', 
            'financeTransactions', 'financeCategories', 'healthMetrics', 
            'healthTimeSeries', 'sleepLogs', 'nutritionLogs', 'waterLogs', 'history'
        ];
        
        const logEl = document.getElementById('backup-log');
        
        // Config
        const REPO_OWNER = 'dawidofski';
        const REPO_NAME = 'backup';
        const FILE_PATH = 'life_organizer_full_backup.json'; // Updated filename for unified DB
        const API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;

        // Inputs
        const tokenInput = document.getElementById('gh-token-input');
        
        function log(msg) {
            const line = document.createElement('div');
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logEl.prepend(line);
        }

        // Load Token
        const savedToken = localStorage.getItem('gh_pat');
        if (savedToken) tokenInput.value = savedToken;

        document.getElementById('btn-save-token').onclick = () => {
            if (tokenInput.value.trim()) {
                localStorage.setItem('gh_pat', tokenInput.value.trim());
                log('‚úÖ Token saved.');
            }
        };

        // --- WIPE LOGIC ---
        async function wipeTables(tableNames, label) {
            if(!confirm(`Are you sure you want to wipe ALL ${label} data? This cannot be undone.`)) return;
            
            log(`‚è≥ Wiping ${label} data...`);
            try {
                await window.db.transaction('rw', tableNames, async () => {
                    for (const name of tableNames) {
                        if (window.db[name]) {
                            await window.db[name].clear();
                        }
                    }
                });
                log(`‚úÖ ${label} data wiped successfully.`);
            } catch (e) {
                log(`‚ùå Error wiping ${label}: ${e.message}`);
                console.error(e);
            }
        }

        document.getElementById('btn-wipe-spanish').onclick = () => wipeTables(SPANISH_TABLES, "Spanish Learning");
        document.getElementById('btn-wipe-life').onclick = () => wipeTables(LIFE_TABLES, "Life Organizer");
        
        document.getElementById('btn-wipe-all').onclick = async () => {
            if(!confirm("‚ö†Ô∏è FACTORY RESET: This will delete EVERYTHING. Are you sure?")) return;
            await window.db.delete();
            location.reload();
        };

        // --- PERFORMANCE CHECK ---
        document.getElementById('btn-perf-check').onclick = async () => {
            log("‚ö° Running diagnostics...");
            const start = performance.now();
            
            try {
                // 1. Write Test
                const ids = await window.db.systemValidation.bulkAdd([
                    { test: 'perf', date: Date.now() },
                    { test: 'perf', date: Date.now() },
                    { test: 'perf', date: Date.now() }
                ]);
                
                // 2. Read Test
                await window.db.systemValidation.where('id').anyOf(ids).toArray();
                
                // 3. Delete Test
                await window.db.systemValidation.bulkDelete(ids);
                
                const end = performance.now();
                const duration = (end - start).toFixed(2);
                
                // Count total records
                let totalRecords = 0;
                for(const table of window.db.tables) {
                    totalRecords += await table.count();
                }

                log(`‚úÖ Check Passed: ${duration}ms`);
                log(`üìä Total Database Records: ${totalRecords}`);
                log(`üíæ Database Open: OK`);
                
            } catch(e) {
                log(`‚ùå Diagnostics Failed: ${e.message}`);
            }
        };

        // --- BACKUP LOGIC (Unified) ---
        // The exportDB function iterates ALL tables in db, so it automatically covers merged schema
        async function exportDB() {
            log('üì¶ Exporting all tables...');
            const data = {};
            await window.db.transaction('r', window.db.tables, async () => {
                for (const table of window.db.tables) {
                    if (table.name !== 'widgetCache') {
                        data[table.name] = await table.toArray();
                    }
                }
            });
            return JSON.stringify(data);
        }

        async function uploadToGitHub(content) {
            const token = localStorage.getItem('gh_pat');
            if (!token) throw new Error("No Token Saved");

            // Get SHA
            let sha = null;
            try {
                const res = await fetch(API_URL, {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (res.ok) sha = (await res.json()).sha;
            } catch(e) {}

            const body = {
                message: `Unified Backup ${new Date().toISOString()}`,
                content: btoa(unescape(encodeURIComponent(content))),
                sha: sha
            };

            const res = await fetch(API_URL, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            if (!res.ok) throw new Error(`GitHub API: ${res.status}`);
        }

        document.getElementById('btn-gh-backup').onclick = async () => {
            const btn = document.getElementById('btn-gh-backup');
            btn.disabled = true;
            try {
                const json = await exportDB();
                await uploadToGitHub(json);
                log('‚úÖ Unified Backup Saved to GitHub!');
            } catch (e) {
                log('‚ùå Backup Failed: ' + e.message);
            }
            btn.disabled = false;
        };

        document.getElementById('btn-gh-restore').onclick = async () => {
            if(!confirm("Overwrite local data with GitHub backup?")) return;
            const btn = document.getElementById('btn-gh-restore');
            btn.disabled = true;
            try {
                const token = localStorage.getItem('gh_pat');
                if (!token) throw new Error("No Token");

                const res = await fetch(API_URL, {
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3.raw' }
                });
                if (!res.ok) throw new Error('Download failed');
                
                const data = await res.json();
                log('üì• Importing...');
                
                await window.db.transaction('rw', window.db.tables, async () => {
                    for (const table of window.db.tables) {
                        if (table.name !== 'widgetCache') {
                            await table.clear();
                            if (data[table.name]) {
                                await table.bulkAdd(data[table.name]);
                            }
                        }
                    }
                });
                log('‚úÖ Restore Complete. Reloading...');
                setTimeout(() => location.reload(), 1500);
            } catch(e) {
                log('‚ùå Restore Failed: ' + e.message);
            }
            btn.disabled = false;
        };
        
        // Widget Update
        document.getElementById('btn-update-widgets').onclick = async () => {
             if (window.loader) {
                log('Checking for updates...');
                await window.loader.checkForUpdates(true);
             }
        };

    })();
</script>