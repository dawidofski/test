<div class="p-4">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold text-gray-800 dark:text-white">Tasks</h2>
        <span id="task-counter" class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-blue-900 dark:text-blue-300">0/0</span>
    </div>

    <div id="task-carousel" class="relative min-h-[100px] flex items-center justify-center">
        <div class="text-gray-400 text-sm">Loading tasks...</div>
    </div>

    <button onclick="openTaskOverlay()" class="mt-4 w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600 transition">
        + Add Task
    </button>
</div>

<!-- Task Overlay (Hidden by default) -->
<div id="add-task-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-md p-6 shadow-2xl">
        <h3 class="text-xl font-bold mb-4 dark:text-white">New Task</h3>
        <input type="text" id="new-task-name" placeholder="Task Name" class="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
        <select id="new-task-priority" class="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="High">High Priority</option>
            <option value="Medium" selected>Medium Priority</option>
            <option value="Low">Low Priority</option>
        </select>
        <div class="flex justify-end gap-2">
            <button onclick="document.getElementById('add-task-modal').classList.add('hidden')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
            <button onclick="saveNewTask()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
        </div>
    </div>
</div>

<script>
(function() {
    // Scoped variables
    let tasks = [];
    let currentIndex = 0;
    const todayStr = new Date().toISOString().split('T')[0];

    // 1. Load Data
    const loadTasks = async () => {
        if (!window.db) return;
        
        // Get all tasks
        const allTasks = await window.db.tasks.toArray();
        const history = await window.db.taskHistory.where('date').equals(todayStr).toArray();
        const completedIds = new Set(history.filter(h => h.status === 'Completed').map(h => h.taskId));
        
        // Filter: Active AND (Due Today OR Overdue) AND Not Completed Today
        tasks = allTasks.filter(t => {
            if (completedIds.has(t.id)) return false;
            if (t.status !== 'Active') return false;
            
            // Simple logic: If no date, it's due. If date <= today, it's due.
            if (!t.dueDate) return true;
            return t.dueDate <= todayStr;
        });

        // Sort: High priority first
        const priorityMap = { 'High': 1, 'Medium': 2, 'Low': 3 };
        tasks.sort((a, b) => priorityMap[a.priority] - priorityMap[b.priority]);

        renderTask();
        updateCounter(completedIds.size, allTasks.length); // Simplified counter logic
    };

    // 2. Render Carousel
    const renderTask = () => {
        const container = document.getElementById('task-carousel');
        
        if (tasks.length === 0) {
            container.innerHTML = `<div class="text-green-600 font-medium">All caught up! üéâ</div>`;
            return;
        }

        if (currentIndex >= tasks.length) currentIndex = 0;
        const task = tasks[currentIndex];
        
        // Priority Colors
        const pColor = task.priority === 'High' ? 'text-red-600' : (task.priority === 'Medium' ? 'text-yellow-600' : 'text-gray-500');

        container.innerHTML = `
            <div class="flex items-center justify-between w-full px-2">
                <button onclick="cycleTask(-1)" class="text-3xl text-gray-300 hover:text-gray-500 select-none">‚ùÆ</button>
                
                <div class="text-center flex-1">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-1">${task.name}</h3>
                    <p class="text-sm ${pColor} font-medium uppercase tracking-wider">${task.priority}</p>
                    <div class="mt-4 flex justify-center gap-4">
                        <button onclick="completeTask(${task.id})" class="w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xl hover:bg-green-200 transition">‚úì</button>
                        <button onclick="skipTask(${task.id})" class="w-12 h-12 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-xl hover:bg-gray-200 transition">‚úï</button>
                    </div>
                </div>

                <button onclick="cycleTask(1)" class="text-3xl text-gray-300 hover:text-gray-500 select-none">‚ùØ</button>
            </div>
        `;
    };

    // 3. Actions
    window.cycleTask = (dir) => {
        currentIndex += dir;
        if (currentIndex < 0) currentIndex = tasks.length - 1;
        if (currentIndex >= tasks.length) currentIndex = 0;
        renderTask();
    };

    window.completeTask = async (id) => {
        await window.db.taskHistory.add({ taskId: id, date: todayStr, status: 'Completed' });
        // Check if recurrence is 'none', then mark main task completed
        const t = tasks.find(x => x.id === id);
        if(t && (!t.recurrenceType || t.recurrenceType === 'none')) {
            await window.db.tasks.update(id, { status: 'Completed' });
        }
        loadTasks();
    };

    window.skipTask = async (id) => {
        // Just move to next in array for UI, essentially skipping for now
        cycleTask(1);
    };

    window.openTaskOverlay = () => document.getElementById('add-task-modal').classList.remove('hidden');
    
    window.saveNewTask = async () => {
        const name = document.getElementById('new-task-name').value;
        const priority = document.getElementById('new-task-priority').value;
        if(!name) return;

        await window.db.tasks.add({
            name,
            priority,
            status: 'Active',
            dueDate: todayStr,
            recurrenceType: 'none',
            createdAt: new Date().toISOString()
        });
        
        document.getElementById('add-task-modal').classList.add('hidden');
        document.getElementById('new-task-name').value = '';
        loadTasks();
    };

    const updateCounter = (done, total) => {
        // Just a visual approximation
        document.getElementById('task-counter').innerText = `${tasks.length} Due`;
    };

    // Init
    loadTasks();
})();
</script>