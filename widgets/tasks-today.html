<style>
    /* Scoped styles for Task Widget */
    #task-widget-container {
        width: 100%;
        height: 100%;
        padding: 15px;
        box-sizing: border-box;
        position: relative;
        display: flex;
        flex-direction: column;
    }
    
    .tw-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .tw-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-color);
    }

    .tw-counter {
        font-size: 14px;
        font-weight: 600;
        color: #fff;
        background: var(--accent-color);
        padding: 4px 10px;
        border-radius: 12px;
    }

    .tw-slide-container {
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        min-height: 100px;
    }

    /* Task Slide Layout */
    .tw-slide {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(0,0,0,0.02);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .tw-info {
        text-align: left;
        flex-grow: 1;
    }

    .tw-name {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 4px;
    }

    .tw-details {
        font-size: 13px;
        color: #888;
    }

    .tw-priority-high { color: #dc3545; font-weight: bold; }
    .tw-priority-medium { color: #ffc107; }
    .tw-priority-low { color: #6c757d; }

    .tw-actions {
        display: flex;
        gap: 15px;
        margin-left: 15px;
    }

    .tw-btn {
        cursor: pointer;
        font-size: 28px;
        transition: transform 0.1s;
        user-select: none;
    }
    .tw-btn:active { transform: scale(0.9); }
    .tw-check { color: #ccc; }
    .tw-check:hover { color: #28a745; }
    .tw-skip { color: #ccc; font-weight: 300; }
    .tw-skip:hover { color: #dc3545; }

    .tw-nav-btn {
        font-size: 24px;
        color: #ccc;
        cursor: pointer;
        padding: 0 10px;
        user-select: none;
    }
    .tw-nav-btn:hover { color: var(--accent-color); }
    .tw-nav-btn.disabled { opacity: 0.3; cursor: default; }

    .tw-msg { font-size: 16px; color: #28a745; font-weight: 600; }
    .tw-error { color: #dc3545; }

    .tw-add-btn {
        width: 100%;
        margin-top: 15px;
        padding: 10px;
        background: rgba(0,0,0,0.05);
        border: none;
        border-radius: 8px;
        color: var(--text-color);
        font-weight: 600;
        cursor: pointer;
    }
    .tw-add-btn:hover { background: rgba(0,0,0,0.1); }

</style>

<div id="task-widget-container">
    <div class="tw-header">
        <div class="tw-title">Tasks Today</div>
        <div class="tw-counter" id="tw-counter">0/0</div>
    </div>

    <div class="tw-slide-container" id="tw-slide-area">
        <div class="tw-msg" style="color: #888;">Loading...</div>
    </div>

    <!-- Navigation (Hidden if empty) -->
    <div style="display: flex; justify-content: center; margin-top: 5px;">
        <span class="tw-nav-btn disabled" id="tw-prev">‚ùÆ</span>
        <span class="tw-nav-btn disabled" id="tw-next">‚ùØ</span>
    </div>

    <button class="tw-add-btn" id="tw-add-btn">+ Add Task</button>
</div>

<script>
(() => {
    // --- Widget Scope Variables ---
    const container = document.getElementById('task-widget-container');
    const slideArea = document.getElementById('tw-slide-area');
    const counterEl = document.getElementById('tw-counter');
    const prevBtn = document.getElementById('tw-prev');
    const nextBtn = document.getElementById('tw-next');
    
    let currentSlideIndex = 0;
    let remainingTasks = [];
    const todayStr = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split("T")[0];

    // --- Helpers ---
    function isDue(task, history) {
        // 1. Filter out completed today
        const completedToday = history.some(h => h.taskId === task.id && h.date === todayStr && h.status === 'Completed');
        if (completedToday) return false;

        // 2. Check Rules
        if (!task.recurrenceType || task.recurrenceType === 'none') {
            return task.dueDate === todayStr || (task.dueDate && task.dueDate < todayStr); // Due or Overdue
        }
        if (task.recurrenceType === 'weekly') {
            const todayIndex = new Date().getDay();
            const isDay = task.recurrenceDays && task.recurrenceDays.includes(todayIndex);
            return isDay && (!task.dueDate || task.dueDate <= todayStr);
        }
        if (task.recurrenceType === 'interval') {
            // Logic simplified for widget: if no history today, assume due if start date passed
            // (Full logic requires checking last completion date)
            return true; 
        }
        return false;
    }

    // --- Core Logic ---
    async function loadData() {
        try {
            const allTasks = await window.db.tasks.where('status').equals('Active').toArray();
            const history = await window.db.taskHistory.toArray(); // Ideally limit this query in v2
            
            const historyToday = history.filter(h => h.date === todayStr && h.status === 'Completed');
            const completedCount = historyToday.length;

            // Filter tasks
            remainingTasks = allTasks.filter(t => isDue(t, history));
            
            // Sort: High priority first
            const pMap = { 'High': 1, 'Medium': 2, 'Low': 3 };
            remainingTasks.sort((a, b) => (pMap[a.priority] || 2) - (pMap[b.priority] || 2));

            const totalCount = remainingTasks.length + completedCount;
            counterEl.textContent = `${completedCount}/${totalCount}`;

            currentSlideIndex = 0;
            renderSlide();

        } catch (e) {
            console.error(e);
            slideArea.innerHTML = `<div class="tw-msg tw-error">Error loading data</div>`;
        }
    }

    function renderSlide() {
        if (remainingTasks.length === 0) {
            slideArea.innerHTML = `<div class="tw-msg">All caught up! üéâ</div>`;
            updateNav();
            return;
        }

        if (currentSlideIndex >= remainingTasks.length) currentSlideIndex = 0;
        if (currentSlideIndex < 0) currentSlideIndex = remainingTasks.length - 1;

        const task = remainingTasks[currentSlideIndex];
        
        slideArea.innerHTML = `
            <div class="tw-slide">
                <div class="tw-info">
                    <div class="tw-name">${task.name}</div>
                    <div class="tw-details">
                        <span class="tw-priority-${task.priority ? task.priority.toLowerCase() : 'medium'}">
                            ${task.priority || 'Medium'}
                        </span>
                        ${task.category ? ` ‚Ä¢ ${task.category}` : ''}
                    </div>
                </div>
                <div class="tw-actions">
                    <div class="tw-btn tw-check" id="tw-btn-complete">‚òê</div>
                    <div class="tw-btn tw-skip" id="tw-btn-skip">‚úï</div>
                </div>
            </div>
        `;

        // Re-attach listeners to the new dynamic elements
        document.getElementById('tw-btn-complete').onclick = () => completeTask(task);
        document.getElementById('tw-btn-skip').onclick = () => skipTask(task);
        
        updateNav();
    }

    function updateNav() {
        if (remainingTasks.length <= 1) {
            prevBtn.classList.add('disabled');
            nextBtn.classList.add('disabled');
        } else {
            prevBtn.classList.remove('disabled');
            nextBtn.classList.remove('disabled');
        }
    }

    // --- Actions ---
    async function completeTask(task) {
        try {
            await window.db.taskHistory.add({
                taskId: task.id,
                date: todayStr,
                status: 'Completed'
            });
            // If non-recurring, mark done
            if (!task.recurrenceType || task.recurrenceType === 'none') {
                await window.db.tasks.update(task.id, { status: 'Completed' });
            }
            loadData(); // Reload
        } catch(e) { console.error(e); }
    }

    async function skipTask(task) {
        try {
            await window.db.taskHistory.add({
                taskId: task.id,
                date: todayStr,
                status: 'Skipped'
            });
            loadData();
        } catch(e) { console.error(e); }
    }

    // --- Event Listeners ---
    prevBtn.onclick = () => {
        if (remainingTasks.length > 1) {
            currentSlideIndex--;
            renderSlide();
        }
    };

    nextBtn.onclick = () => {
        if (remainingTasks.length > 1) {
            currentSlideIndex++;
            renderSlide();
        }
    };

    document.getElementById('tw-add-btn').onclick = () => {
        // Simple quick add prompt for now, or trigger overlay if implemented
        const name = prompt("Task Name:");
        if(name) {
            window.db.tasks.add({
                name: name,
                status: 'Active',
                priority: 'Medium',
                dueDate: todayStr,
                recurrenceType: 'none'
            }).then(loadData);
        }
    };

    // Init
    loadData();

})();
</script>