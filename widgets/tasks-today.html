<style>
    /* --- Layout & Container --- */
    .tw-widget {
        width: 100%;
        height: 100%;
        padding: 15px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
    }

    /* Capture vertical scrolls but allow horizontal swipes */
    .widget-swipe-area {
        touch-action: pan-y;
    }

    /* --- Header --- */
    .tw-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        min-height: 30px;
    }

    .tw-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-color);
    }

    .tw-dots {
        display: flex;
        gap: 5px;
    }

    .tw-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #ccc;
        transition: background 0.3s;
    }

    .tw-dot.active {
        background: var(--accent-color);
    }

    /* --- Views Carousel --- */
    .tw-views-wrapper {
        flex-grow: 1;
        position: relative;
        width: 100%;
        min-height: 200px;
        /* Ensure space for content */
    }

    .tw-view {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease, transform 0.3s ease;
        transform: translateX(20px);
        display: flex;
        flex-direction: column;
        background: var(--card-bg);
        /* Opaque background */
        z-index: 0;
        overflow-y: auto;
        /* Scroll internal content */
    }

    @media (prefers-color-scheme: dark) {
        .tw-view {
            background: #1e1e1e;
        }
    }

    .tw-view.active {
        opacity: 1;
        pointer-events: all;
        transform: translateX(0);
        z-index: 10;
    }

    /* =========================
       VIEW 1: TASKS STYLES
       ========================= */
    .tw-counter {
        font-size: 14px;
        font-weight: 600;
        color: #fff;
        background: var(--accent-color);
        padding: 4px 10px;
        border-radius: 12px;
        align-self: flex-end;
        margin-bottom: 5px;
    }

    .tw-slide-container {
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .tw-slide {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(0, 0, 0, 0.02);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .tw-info {
        text-align: left;
        flex-grow: 1;
    }

    .tw-name {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 4px;
    }

    .tw-details {
        font-size: 13px;
        color: #888;
    }

    .tw-priority-high {
        color: #dc3545;
        font-weight: bold;
    }

    .tw-priority-medium {
        color: #ffc107;
    }

    .tw-priority-low {
        color: #6c757d;
    }

    .tw-actions {
        display: flex;
        gap: 15px;
        margin-left: 15px;
    }

    .tw-btn {
        cursor: pointer;
        font-size: 36px;
        line-height: 1;
        transition: transform 0.1s;
        user-select: none;
    }

    .tw-btn:active {
        transform: scale(0.9);
    }

    .tw-check {
        color: #ccc;
    }

    .tw-check:hover {
        color: #28a745;
    }

    .tw-skip {
        color: #ccc;
        font-weight: 300;
    }

    .tw-skip:hover {
        color: #dc3545;
    }

    .tw-nav {
        display: flex;
        justify-content: center;
        margin-top: 5px;
    }

    .tw-nav-btn {
        font-size: 24px;
        color: #ccc;
        cursor: pointer;
        padding: 0 10px;
        user-select: none;
    }

    .tw-nav-btn:hover {
        color: var(--accent-color);
    }

    .tw-nav-btn.disabled {
        opacity: 0.3;
        cursor: default;
    }

    .tw-add-btn {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: var(--accent-color);
        color: white;
        font-size: 24px;
        border: none;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
    }

    .tw-msg {
        color: #888;
    }

    /* =========================
       VIEW 2: GOALS STYLES
       ========================= */
    .gw-controls {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .gw-filter {
        padding: 5px;
        font-size: 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background: var(--card-bg);
        color: var(--text-color);
    }

    /* Goal List */
    .gw-list {
        list-style: none;
        padding: 0;
        margin: 0;
        flex-grow: 1;
        overflow-y: auto;
    }

    .goal-item {
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 8px 0;
    }

    .goal-summary {
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        padding: 5px;
        border-radius: 6px;
    }

    .goal-summary:hover {
        background: rgba(0, 0, 0, 0.02);
    }

    /* Custom Triangle for Details */
    .goal-summary::-webkit-details-marker {
        display: none;
    }

    .goal-summary::marker {
        display: none;
        content: "";
    }

    .goal-summary::before {
        content: '‚ñ∂';
        display: inline-block;
        font-size: 10px;
        color: #ccc;
        margin-right: 8px;
        transition: transform 0.2s;
    }

    details[open]>.goal-summary::before {
        transform: rotate(90deg);
    }

    .goal-summary.no-subgoals::before {
        opacity: 0;
    }

    .goal-text {
        font-weight: 600;
        font-size: 14px;
        flex-grow: 1;
    }

    .goal-text.completed {
        text-decoration: line-through;
        color: #aaa;
    }

    /* Progress Bar */
    .gw-progress-container {
        height: 4px;
        background: #eee;
        border-radius: 2px;
        margin-top: 4px;
        margin-left: 20px;
        overflow: hidden;
    }

    .gw-progress-bar {
        height: 100%;
        background: #28a745;
        transition: width 0.3s;
    }

    /* Actions */
    .gw-actions {
        display: flex;
        gap: 8px;
        opacity: 0.5;
        transition: opacity 0.2s;
    }

    .goal-item:hover .gw-actions {
        opacity: 1;
    }

    .gw-icon-btn {
        cursor: pointer;
        font-size: 14px;
        background: none;
        border: none;
        padding: 0;
    }

    /* Subgoals */
    .subgoal-list {
        list-style: none;
        padding-left: 20px;
        margin-top: 5px;
        border-left: 2px solid #eee;
    }

    .subgoal-item {
        display: flex;
        align-items: center;
        padding: 4px 0;
        font-size: 13px;
    }

    .subgoal-checkbox {
        margin-right: 8px;
    }

    .subgoal-text {
        flex-grow: 1;
    }

    .financial-amount {
        font-weight: bold;
        color: #28a745;
        margin-left: 5px;
    }

    /* Floating Add Button for Goals */
    .gw-fab {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: var(--accent-color);
        color: white;
        font-size: 24px;
        border: none;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
    }

    /* --- Overlays (Common Styles) --- */
    .tw-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
    }

    .tw-overlay-content {
        background: var(--card-bg);
        padding: 25px;
        border-radius: 10px;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        max-height: 85vh;
        overflow-y: auto;
        color: var(--text-color);
    }

    .tw-form-field {
        margin-bottom: 15px;
    }

    .tw-form-field label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        font-size: 13px;
    }

    .tw-form-field input,
    .tw-form-field select,
    .tw-form-field textarea {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
    }

    .tw-form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    .tw-btn-save {
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
    }

    .tw-btn-cancel {
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
    }

    /* Day Selector (Task Specific) */
    .tw-day-selector {
        display: flex;
        gap: 5px;
    }

    .tw-day-selector button {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        background: #f0f0f0;
        cursor: pointer;
    }

    .tw-day-selector button.selected {
        background: var(--accent-color);
        color: white;
    }
</style>

<div class="tw-widget widget-swipe-area" id="tw-widget-root">

    <div class="tw-header-row">
        <div class="tw-title" id="tw-main-title">Tasks</div>
        <div class="tw-dots">
            <div class="tw-dot active" data-idx="0"></div>
            <div class="tw-dot" data-idx="1"></div>
        </div>
    </div>

    <div class="tw-views-wrapper">

        <div class="tw-view active" id="tw-view-0">
            <div class="tw-counter" id="tw-counter">0/0</div>

            <div class="tw-slide-container" id="tw-slide-area">
                <div class="tw-msg">Loading...</div>
            </div>

            <div class="tw-nav">
                <span class="tw-nav-btn disabled" id="tw-prev">‚ùÆ</span>
                <span class="tw-nav-btn disabled" id="tw-next">‚ùØ</span>
            </div>

            <button class="tw-add-btn" id="tw-add-task-btn">+</button>
        </div>

        <div class="tw-view" id="tw-view-1">
            <div class="gw-controls">
                <select id="gw-category-filter" class="gw-filter">
                    <option value="all">All Goals</option>
                    <option value="general">General</option>
                    <option value="financial">Financial</option>
                    <option value="health">Health</option>
                    <option value="career">Career</option>
                </select>
            </div>

            <ul id="gw-goal-list" class="gw-list">
                <li style="padding:10px; color:#888;">Loading goals...</li>
            </ul>

            <button class="gw-fab" id="gw-add-btn" title="Add Goal">+</button>
        </div>

    </div>
</div>

<div id="tw-overlay" class="tw-overlay">
    <div class="tw-overlay-content">
        <h2>Add Task</h2>
        <form id="tw-form">
            <div class="tw-form-field">
                <label>Name</label>
                <input type="text" id="tw-name" required>
            </div>
            <div class="tw-form-field">
                <label>Category</label>
                <input type="text" id="tw-category">
            </div>
            <div class="tw-form-field">
                <label>Priority</label>
                <select id="tw-priority">
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                </select>
            </div>
            <div class="tw-form-field">
                <label>Due Date</label>
                <input type="date" id="tw-due-date">
            </div>
            <div class="tw-form-actions">
                <button type="button" id="tw-close-btn" class="tw-btn-cancel">Cancel</button>
                <button type="submit" class="tw-btn-save">Save Task</button>
            </div>
        </form>
    </div>
</div>

<div id="gw-overlay" class="tw-overlay">
    <div class="tw-overlay-content">
        <h2 id="gw-overlay-title">Edit Goal</h2>
        <form id="gw-form">
            <input type="hidden" id="gw-id">
            <div class="tw-form-field">
                <label>Goal Name</label>
                <input type="text" id="gw-name" required>
            </div>
            <div class="tw-form-field">
                <label>Category</label>
                <select id="gw-category">
                    <option value="general">General</option>
                    <option value="financial">Financial</option>
                    <option value="health">Health</option>
                    <option value="career">Career</option>
                    <option value="personal">Personal</option>
                </select>
            </div>
            <div class="tw-form-field" id="gw-financial-group" style="display:none;">
                <label id="gw-financial-label">Target Amount ($)</label>
                <input type="number" id="gw-target" step="0.01">
            </div>
            <div class="tw-form-field">
                <label>Due Date</label>
                <input type="date" id="gw-due">
            </div>
            <div class="tw-form-actions">
                <button type="button" id="gw-close-btn" class="tw-btn-cancel">Cancel</button>
                <button type="submit" class="tw-btn-save">Save Goal</button>
            </div>
        </form>
    </div>
</div>

<script>
    (() => {
        // === ROOT & NAVIGATION ===
        const root = document.getElementById('tw-widget-root');
        const titleEl = document.getElementById('tw-main-title');
        const dots = root.querySelectorAll('.tw-dot');
        const views = [
            document.getElementById('tw-view-0'),
            document.getElementById('tw-view-1')
        ];
        const titles = ["Tasks", "Goals"];

        let currentView = 0;

        // Check for zombie widget
        const isAlive = () => root && root.isConnected;

        // --- Swipe Logic ---
        let touchStartX = 0;
        let touchStartY = 0;

        root.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });

        root.addEventListener('touchend', e => {
            if (!isAlive()) return;
            const diffX = touchStartX - e.changedTouches[0].screenX;
            const diffY = touchStartY - e.changedTouches[0].screenY;
            // Ignore small swipes or vertical scrolls
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 40) {
                switchView(diffX > 0 ? 1 : -1);
            }
        }, { passive: true });

        function switchView(dir) {
            if (!isAlive()) return;
            views[currentView].classList.remove('active');
            dots[currentView].classList.remove('active');

            currentView += dir;
            if (currentView >= views.length) currentView = 0;
            if (currentView < 0) currentView = views.length - 1;

            views[currentView].classList.add('active');
            dots[currentView].classList.add('active');
            titleEl.textContent = titles[currentView];

            if (currentView === 1) loadGoals(); // Refresh goals on view
        }


        // ===============================================
        // LOGIC 1: TASKS (From previous widget)
        // ===============================================
        const slideArea = document.getElementById('tw-slide-area');
        const counterEl = document.getElementById('tw-counter');
        const prevBtn = document.getElementById('tw-prev');
        const nextBtn = document.getElementById('tw-next');
        let taskQueue = [];
        let currentTaskIdx = 0;
        const todayStr = new Date().toISOString().split("T")[0];

        async function loadTasks() {
            if (!isAlive()) return;
            try {
                const allTasks = await window.db.tasks.where('status').equals('Active').toArray();
                const history = await window.db.taskHistory.toArray();

                // Filter: Completed Today
                const completedToday = history.filter(h => h.date === todayStr && h.status === 'Completed');
                const completedIds = new Set(completedToday.map(h => h.taskId));

                // Filter: Due or Overdue
                const relevant = allTasks.filter(t => {
                    if (completedIds.has(t.id)) return false;
                    // Simple Due Logic (Extendable)
                    if (t.dueDate && t.dueDate <= todayStr) return true;
                    // Show standard non-dated active tasks too? Let's stick to due for widget brevity
                    if (!t.dueDate) return true;
                    return false;
                });

                // Sort: Priority
                const pMap = { 'High': 3, 'Medium': 2, 'Low': 1 };
                relevant.sort((a, b) => (pMap[b.priority] || 0) - (pMap[a.priority] || 0));

                taskQueue = relevant;
                counterEl.textContent = `${completedToday.length}/${relevant.length + completedToday.length}`;

                renderTaskSlide();

            } catch (e) { console.error(e); }
        }

        function renderTaskSlide() {
            if (!isAlive()) return;
            if (taskQueue.length === 0) {
                slideArea.innerHTML = `<div class="tw-msg" style="color:#28a745">All caught up! üéâ</div>`;
                prevBtn.classList.add('disabled');
                nextBtn.classList.add('disabled');
                return;
            }

            if (currentTaskIdx >= taskQueue.length) currentTaskIdx = 0;
            if (currentTaskIdx < 0) currentTaskIdx = taskQueue.length - 1;

            const task = taskQueue[currentTaskIdx];
            const isOverdue = task.dueDate && task.dueDate < todayStr;

            slideArea.innerHTML = `
            <div class="tw-slide">
                <div class="tw-info">
                    <div class="tw-name">${task.name}</div>
                    <div class="tw-details">
                        ${isOverdue ? '<span class="tw-priority-high">OVERDUE</span>' : `<span class="tw-priority-${task.priority.toLowerCase()}">${task.priority}</span>`}
                        ${task.category ? `‚Ä¢ ${task.category}` : ''}
                    </div>
                </div>
                <div class="tw-actions">
                    <div class="tw-btn tw-check" id="tw-act-c-${task.id}">‚òê</div>
                    <div class="tw-btn tw-skip" id="tw-act-s-${task.id}">‚úï</div>
                </div>
            </div>
        `;

            document.getElementById(`tw-act-c-${task.id}`).onclick = () => finishTask(task, 'Completed');
            document.getElementById(`tw-act-s-${task.id}`).onclick = () => finishTask(task, 'Skipped');

            prevBtn.classList.toggle('disabled', taskQueue.length <= 1);
            nextBtn.classList.toggle('disabled', taskQueue.length <= 1);
        }

        async function finishTask(task, status) {
            await window.db.taskHistory.add({ taskId: task.id, date: todayStr, status: status });
            // Auto-complete one-off tasks
            if (!task.recurrenceType || task.recurrenceType === 'none') {
                await window.db.tasks.update(task.id, { status: 'Completed' });
            }
            loadTasks();
        }

        prevBtn.onclick = () => { if (taskQueue.length > 1) { currentTaskIdx--; renderTaskSlide(); } };
        nextBtn.onclick = () => { if (taskQueue.length > 1) { currentTaskIdx++; renderTaskSlide(); } };

        // --- Task Overlay ---
        const tOverlay = document.getElementById('tw-overlay');
        const tForm = document.getElementById('tw-form');
        document.getElementById('tw-add-task-btn').onclick = () => {
            tForm.reset();
            document.getElementById('tw-due-date').value = todayStr;
            tOverlay.style.display = 'flex';
        };
        document.getElementById('tw-close-btn').onclick = () => tOverlay.style.display = 'none';

        tForm.onsubmit = async (e) => {
            e.preventDefault();
            await window.db.tasks.add({
                name: document.getElementById('tw-name').value,
                category: document.getElementById('tw-category').value,
                priority: document.getElementById('tw-priority').value,
                dueDate: document.getElementById('tw-due-date').value,
                status: 'Active',
                recurrenceType: 'none'
            });
            tOverlay.style.display = 'none';
            loadTasks();
        };


        // ===============================================
        // LOGIC 2: GOALS (New Integration)
        // ===============================================
        const goalListEl = document.getElementById('gw-goal-list');
        const catFilter = document.getElementById('gw-category-filter');

        async function loadGoals() {
            if (!isAlive()) return;
            try {
                const allGoals = await window.db.goals.toArray();
                const filter = catFilter.value;

                // Build Tree
                const map = new Map();
                allGoals.forEach(g => { g.subgoals = []; map.set(g.id, g); });

                const roots = [];
                allGoals.forEach(g => {
                    if (g.parentId) {
                        const p = map.get(g.parentId);
                        if (p) p.subgoals.push(g);
                    } else {
                        if (filter === 'all' || g.category === filter) roots.push(g);
                    }
                });

                roots.sort((a, b) => a.name.localeCompare(b.name));
                renderGoals(roots);

            } catch (e) { console.error(e); }
        }

        function renderGoals(roots) {
            goalListEl.innerHTML = '';
            if (roots.length === 0) {
                goalListEl.innerHTML = `<li style="padding:10px; color:#aaa;">No goals found.</li>`;
                return;
            }

            roots.forEach(g => {
                const li = document.createElement('li');
                li.className = 'goal-item';

                // Calculate Progress
                const hasSubs = g.subgoals.length > 0;
                let pct = 0;
                let label = "";
                const isFin = g.category === 'financial';

                if (hasSubs) {
                    if (isFin) {
                        const total = g.targetAmount || 1;
                        const saved = g.subgoals.reduce((sum, sg) => sum + (sg.targetAmount || 0), 0);
                        pct = Math.min((saved / total) * 100, 100);
                        label = `$${saved} / $${total}`;
                    } else {
                        const done = g.subgoals.filter(s => s.isComplete).length;
                        pct = (done / g.subgoals.length) * 100;
                        label = `${done}/${g.subgoals.length}`;
                    }
                }

                // HTML Structure
                const progressHtml = hasSubs ?
                    `<div class="gw-progress-container" title="${label}"><div class="gw-progress-bar" style="width:${pct}%"></div></div>` : '';

                li.innerHTML = `
                <details ${hasSubs ? '' : 'disabled'}>
                    <summary class="goal-summary ${hasSubs ? '' : 'no-subgoals'}">
                        <span class="goal-text ${g.isComplete ? 'completed' : ''}">${g.name}</span>
                        <div class="gw-actions">
                            <button class="gw-icon-btn add-sub" title="Add Subgoal">‚ûï</button>
                            <button class="gw-icon-btn edit" title="Edit">‚úèÔ∏è</button>
                            <button class="gw-icon-btn del" title="Delete">üóëÔ∏è</button>
                        </div>
                    </summary>
                    <ul class="subgoal-list"></ul>
                </details>
                ${progressHtml}
            `;

                // Render Subgoals
                const subUl = li.querySelector('.subgoal-list');
                g.subgoals.forEach(sg => {
                    const subLi = document.createElement('li');
                    subLi.className = 'subgoal-item';
                    const isFinSub = sg.category === 'financial';

                    subLi.innerHTML = `
                    ${isFinSub ? '' : `<input type="checkbox" class="subgoal-checkbox" ${sg.isComplete ? 'checked' : ''}>`}
                    <span class="subgoal-text ${sg.isComplete ? 'completed' : ''}">
                        ${sg.name}
                        ${isFinSub ? `<span class="financial-amount">+$${sg.targetAmount}</span>` : ''}
                    </span>
                    <div class="gw-actions">
                         <button class="gw-icon-btn edit">‚úèÔ∏è</button>
                         <button class="gw-icon-btn del">üóëÔ∏è</button>
                    </div>
                `;

                    // Subgoal Events
                    if (!isFinSub) subLi.querySelector('input').onchange = (e) => toggleGoal(sg.id, e.target.checked);
                    subLi.querySelector('.edit').onclick = () => openGoalModal(sg.id);
                    subLi.querySelector('.del').onclick = () => deleteGoal(sg.id);
                    subUl.appendChild(subLi);
                });

                // Parent Events
                li.querySelector('.add-sub').onclick = (e) => { e.preventDefault(); addSubgoal(g); };
                li.querySelector('.edit').onclick = (e) => { e.preventDefault(); openGoalModal(g.id); };
                li.querySelector('.del').onclick = (e) => { e.preventDefault(); deleteGoal(g.id); };

                goalListEl.appendChild(li);
            });
        }

        // --- Goal Actions ---
        async function toggleGoal(id, status) {
            await window.db.goals.update(id, { isComplete: status });
            // Check Parent status logic could go here (omitted for brevity)
            loadGoals();
        }

        async function deleteGoal(id) {
            if (!confirm("Delete this goal?")) return;
            // Recursive delete not fully implemented in widget for safety/brevity, just deleting node
            // Ideally should delete children too.
            await window.db.goals.delete(id);
            loadGoals();
        }

        async function addSubgoal(parent) {
            const isFin = parent.category === 'financial';
            const name = prompt(isFin ? "Contribution Name:" : "Subgoal Name:");
            if (!name) return;

            let amount = null;
            if (isFin) {
                amount = parseFloat(prompt("Amount ($):"));
                if (isNaN(amount)) return;
            }

            await window.db.goals.add({
                name: name,
                parentId: parent.id,
                isComplete: false,
                category: parent.category,
                targetAmount: amount
            });
            loadGoals();
        }

        // --- Goal Overlay ---
        const gOverlay = document.getElementById('gw-overlay');
        const gForm = document.getElementById('gw-form');

        function openGoalModal(id = null) {
            gForm.reset();
            document.getElementById('gw-id').value = id || "";
            const finGroup = document.getElementById('gw-financial-group');

            if (id) {
                window.db.goals.get(id).then(g => {
                    document.getElementById('gw-name').value = g.name;
                    document.getElementById('gw-category').value = g.category || 'general';
                    document.getElementById('gw-due').value = g.dueDate || '';
                    if (g.category === 'financial') {
                        finGroup.style.display = 'block';
                        document.getElementById('gw-target').value = g.targetAmount;
                    } else {
                        finGroup.style.display = 'none';
                    }
                    document.getElementById('gw-overlay-title').textContent = "Edit Goal";
                    gOverlay.style.display = 'flex';
                });
            } else {
                finGroup.style.display = 'none'; // Default hidden
                document.getElementById('gw-overlay-title').textContent = "New Goal";
                gOverlay.style.display = 'flex';
            }
        }

        // Toggle financial input
        document.getElementById('gw-category').onchange = (e) => {
            const isFin = e.target.value === 'financial';
            const label = document.getElementById('gw-financial-label');
            document.getElementById('gw-financial-group').style.display = isFin ? 'block' : 'none';
            label.textContent = "Target Amount ($)";
        };

        document.getElementById('gw-add-btn').onclick = () => openGoalModal(null);
        document.getElementById('gw-close-btn').onclick = () => gOverlay.style.display = 'none';
        catFilter.onchange = loadGoals;

        gForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('gw-id').value;
            const cat = document.getElementById('gw-category').value;
            const data = {
                name: document.getElementById('gw-name').value,
                category: cat,
                dueDate: document.getElementById('gw-due').value,
                targetAmount: cat === 'financial' ? parseFloat(document.getElementById('gw-target').value) : null
            };

            if (id) await window.db.goals.update(parseInt(id), data);
            else await window.db.goals.add({ ...data, parentId: null, isComplete: false });

            gOverlay.style.display = 'none';
            loadGoals();
        };

        // Init
        loadTasks();
        loadGoals();

    })();
</script>