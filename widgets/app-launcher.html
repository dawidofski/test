<style>
    #app-list-container {
        width: 100%;
        padding-bottom: 20px;
    }
    
    .app-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .app-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .app-item:hover {
        background-color: rgba(0,0,0,0.03);
    }

    .app-icon {
        width: 40px;
        height: 40px;
        margin-right: 15px;
        border-radius: 8px;
        object-fit: cover;
        background: #eee; /* Placeholder */
    }

    .app-info {
        flex-grow: 1;
    }

    .app-label {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-color);
        display: block;
    }

    .app-pkg {
        font-size: 12px;
        color: #888;
    }
    
    .refresh-btn {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        background: transparent;
        border: 1px solid #ccc;
        color: var(--text-color);
        border-radius: 8px;
        cursor: pointer;
    }
</style>

<div id="app-list-container">
    <div id="loading-apps" style="text-align: center; color: #888; padding: 20px;">
        Loading apps...
    </div>
    <ul id="app-list" class="app-list"></ul>
    <button class="refresh-btn" id="refresh-apps">Refresh App List</button>
</div>


<script>
    (() => {
        const listEl = document.getElementById('app-list');
        const loadingEl = document.getElementById('loading-apps');
        const refreshBtn = document.getElementById('refresh-apps');
    
        // --- Mock Data for Browser ---
        const MOCK_APPS = [
            { label: 'Settings', packageName: 'com.android.settings' },
            { label: 'Chrome', packageName: 'com.android.chrome' },
            { label: 'Camera', packageName: 'com.android.camera' },
            { label: 'Maps', packageName: 'com.google.android.apps.maps' }
        ];
    
        async function loadApps() {
            listEl.innerHTML = '';
            loadingEl.style.display = 'block';
            let apps = [];
    
            try {
                if (window.Bridge && window.Bridge.getAppsURL) {
                    const url = window.Bridge.getAppsURL();
                    const res = await fetch(url);
                    const data = await res.json();
                    apps = data.apps;
                    apps.sort((a, b) => a.label.localeCompare(b.label));
                } else {
                    console.log("Using mock apps.");
                    await new Promise(r => setTimeout(r, 500));
                    apps = MOCK_APPS;
                }
                renderApps(apps);
            } catch (e) {
                console.error(e);
                loadingEl.textContent = "Error loading apps.";
            }
        }
    
        function renderApps(apps) {
            loadingEl.style.display = 'none';
            if (apps.length === 0) {
                loadingEl.textContent = "No apps found.";
                loadingEl.style.display = 'block';
                return;
            }
    
            apps.forEach(app => {
                const li = document.createElement('li');
                li.className = 'app-item';
                
                let iconSrc = window.Bridge && window.Bridge.getDefaultAppIconURL 
                    ? window.Bridge.getDefaultAppIconURL(app.packageName) 
                    : 'https://via.placeholder.com/40';
    
                li.innerHTML = `
                    <img src="${iconSrc}" class="app-icon" alt="icon" onerror="this.src='https://via.placeholder.com/40'">
                    <div class="app-info">
                        <span class="app-label">${app.label}</span>
                        <span class="app-pkg">${app.packageName}</span>
                    </div>
                `;
    
                li.onclick = () => {
                    if (window.Bridge && window.Bridge.requestLaunchApp) {
                        window.Bridge.requestLaunchApp(app.packageName);
                    } else {
                        alert(`Launching ${app.label}`);
                    }
                };
                listEl.appendChild(li);
            });
        }
    
        refreshBtn.onclick = loadApps;
    
        // --- SEARCH & GOOGLE FALLBACK LOGIC ---
        const searchInput = document.querySelector('#overlay-launcher .overlay-header input');
        
        if (searchInput) {
            // 1. Live Filtering (Use 'input' event for instant feedback)
            searchInput.oninput = (e) => {
                const term = e.target.value.toLowerCase();
                const items = listEl.querySelectorAll('.app-item');
                
                items.forEach(item => {
                    const label = item.querySelector('.app-label').textContent.toLowerCase();
                    item.style.display = label.includes(term) ? 'flex' : 'none';
                });
            };
    
            // 2. Google Search Action (Use 'keydown' for reliable Enter key)
            searchInput.onkeydown = (e) => {
                // Check for Enter key (key 'Enter' or code 13)
                if (e.key === 'Enter' || e.keyCode === 13) {
                    const term = e.target.value.trim();
                    if (term.length === 0) return;
    
                    // Count currently visible apps
                    const items = listEl.querySelectorAll('.app-item');
                    let visibleCount = 0;
                    items.forEach(item => {
                        if (item.style.display !== 'none') visibleCount++;
                    });
    
                    // If no apps found, Search Google
                    if (visibleCount === 0) {
                        // IMPORTANT: Blur input to close mobile keyboard
                        searchInput.blur();
                        
                        const query = encodeURIComponent(term);
                        window.open(`https://www.google.com/search?q=${query}`, '_blank');
                    }
                }
            };
            
            // Focus input on load
            searchInput.focus();
        }
    
        loadApps();
    })();
    </script>